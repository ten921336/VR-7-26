<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <style>
      body {
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="timeContainer" style="position: absolute; top: 10px; right: 10px; font-size: 24px; color: rgb(10, 10, 10);"></div>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.150.1/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.150.1/examples/jsm/",
          "webxr-polyfill": "https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.module.js"
        }
      }
    </script>

    <script type="module">
      // three.jsの読み込み
      import * as THREE from "three";
      // WebVRの判定、遷移ボタンのスクリプト
      import { VRButton } from "three/addons/webxr/VRButton.js";

      // WebXRのポリフィルを読み込み
      import WebXRPolyfill from "webxr-polyfill";
      //コントローラa
      import { XRControllerModelFactory } from 'https://unpkg.com/three@0.150.1/examples/jsm/webxr/XRControllerModelFactory.js';
      
      //スコア変数
      let score=1;
      let scores=0;
      //コントローラー
      let controller1, controller2;
      let controllerGrip1, controllerGrip2;

      // 秒数を表示するテキスト要素を取得
      const timeContainer = document.getElementById("timeContainer");
      //時間60秒になったら停止するための変数
      let shouldStopRendering = false;

      // WebXRのポリフィルを有効にする
      const polyfill = new WebXRPolyfill();

      // サイズを指定
      const width = window.innerWidth;
      const height = window.innerHeight;
      
    
      // レンダラーを作成
      let renderer = new THREE.WebGLRenderer({
        antialias: true,
      });
      renderer.setSize(width, height);
      renderer.setPixelRatio( window.devicePixelRatio );
      renderer.outputEncoding = THREE.sRGBEncoding;

      // レンダラーのWebVR設定を有効にする
      console.log(renderer);
      renderer.xr.enabled = true;

      document.body.appendChild(renderer.domElement);

      // WebVRの開始ボタンをDOMに追加
      document.body.appendChild(VRButton.createButton(renderer));

      // シーンを作成
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x00bfff);

      // カメラを作成
      const camera = new THREE.PerspectiveCamera(0, width / height);
      

      // カメラ用コンテナを作成
      const cameraContainer = new THREE.Object3D();
      cameraContainer.add(camera);
      scene.add(cameraContainer);
      cameraContainer.position.y = 0.01;
      
    //   光源を作成
      {
        const spotLight = new THREE.SpotLight(
          0xffffff,
          4,
          2000,
          Math.PI / 5,
          0.2,
          1.5
        );
        spotLight.position.set(0, 9, 5);
        scene.add(spotLight);

        const ambientLight = new THREE.AmbientLight(0x333333);
        scene.add(ambientLight);
      }

  /* ----コントローラー設定----- */
  
  // コントローラーイベントの設定
  function onSelectStart() {
    this.userData.isSelecting = true;
  }
  function onSelectEnd() {
    this.userData.isSelecting = false;
  }	

  //コントローラー取得
  controller1 = renderer.xr.getController( 0 );
  controller1.addEventListener( 'selectstart', onSelectStart );
  controller1.addEventListener( 'selectend', onSelectEnd );
  scene.add( controller1 );
  controller2 = renderer.xr.getController( 1 );
  controller2.addEventListener( 'selectstart', onSelectStart );
  controller2.addEventListener( 'selectend', onSelectEnd );
  scene.add( controller2 );

  //コントローラーモデルを取得
  const controllerModelFactory = new XRControllerModelFactory();
  controllerGrip1 = renderer.xr.getControllerGrip(0);
  controllerGrip1.add( controllerModelFactory.createControllerModel( controllerGrip1 ) );
  scene.add( controllerGrip1 );
  controllerGrip2 = renderer.xr.getControllerGrip(1);
  controllerGrip2.add( controllerModelFactory.createControllerModel( controllerGrip2 ) );
  scene.add( controllerGrip2 );
  //コントローラーから出る光線の作成				
  const geo = new THREE.BufferGeometry().setFromPoints( [ new THREE.Vector3( 0, 0, 0 ), new THREE.Vector3( 0, 0, - 1 )]);
  const line = new THREE.Line( geo );
  line.name = 'line';
  line.scale.z = 5;
  controller1.add( line.clone() );
  controller2.add( line.clone() );
  

  //機能
	var coolTime = 0;
	function handleController( controller ) {
		const userData = controller.userData;
		if ( userData.isSelecting === true ) {//コントローラーボタンが押された際の処理
      if(coolTime===0){   //coolTimeが0なら処理を行う
        const cube = createCube();
        cube.position.set(0,1,-0.5);
        scene.add(cube);
        // coolTimeを設ける。数値は0以外なら何でも良い。
        coolTime=1;
        setTimeout(function() {
          coolTime=0; // coolTimeを0にする処理
        }, 500); //coolTimeが0.5秒
        setTimeout(function() {
          //cubeを消す
          scene.remove(cube);
        }, 200);
      }
		} else {
      
		}
	}
  /* ----コントローラー設定----- */
  
  // 立方体を生成する関数
  function createCube() {
    const geometry = new THREE.BoxGeometry();
    const material1 = new THREE.MeshBasicMaterial({ color: 'red' });//色を固定
    const cube = new THREE.Mesh(geometry, material1);
    return cube;
  }


      // 地面を作成
      {
        // 床のテクスチャー
        {
          const gridHelper = new THREE.GridHelper(10,9,0xffffff,0xffffff);scene.add(gridHelper);
          //gridHelper.position.y=50;
		      const pg = new THREE.PlaneGeometry( 10, 10 );
		      const pm = new THREE.MeshBasicMaterial( {color: 0x808080, side: THREE.DoubleSide} );
		      const plane = new THREE.Mesh(pg, pm); plane.rotation.x =-Math.PI/2;
          //plane.position.y=10;
		      scene.add( plane );
		      scene.add( new THREE.HemisphereLight( 0x888877, 0x777788 ) );
        }
      }
      const boxList = [];

      // 立方体を作成
      {
        // 立方体のジオメトリを作成
        const geometry = new THREE.BoxGeometry(0.3, 0.3, 0.3);
        // 立方体を複数作成しランダムに配置
        const num = 60;
        loop: for (let i = 0; i < num; i++) {
          const px = Math.round((Math.random() - 0.5) * 19) * 0.5;
          const py = Math.round((Math.random() - 0.5) * 15) * 0.1 + 2.25;
          const pz = Math.round((Math.random() - 0.5) * 19) * 0.5;
          for (let j = 0; j < i; j++) {
            const box2 = boxList[j];
            if (box2.position.x === px && box2.position.z === pz) {
              i -= 1;
              continue loop;
            }
          }
          // 立方体のマテリアルを作成
          const material = new THREE.MeshStandardMaterial({
            color: 0x1000000 * Math.random(),
            roughness: 0.1,
            metalness: 0.5,
          });
          const box = new THREE.Mesh(geometry, material);
          box.position.x = px;
          box.position.y = py;
          box.position.z = pz;
          scene.add(box);
          boxList.push(box);
        }
      }

  // レンダラーにループ関数を登録
  renderer.setAnimationLoop(tick);
  

      function render() {
  tick();
  handleController( controller1 );
		handleController( controller2 );
  if (!shouldStopRendering) {
    updateTime();
  }
}

// 初回のレンダリングループの開始
renderer.setAnimationLoop(render);

      let time = 0;

      // 毎フレーム時に実行されるループイベント
      function tick() {
        time += 1;

        // 立方体を動かす
        const length = boxList.length;  
        for (let i = 0; i < length; i++) {
          if(i%3==0){
            boxList[i].position.y =
          2 + 1.5 * Math.cos(time * 0.0175  + i/2);
          }else if(i%3==1){
            boxList[i].position.z =
          4 * Math.cos(time * 0.0175  + i/2);
          }else{
            boxList[i].position.x =
          4 * Math.cos(time * 0.0175  + i/2);
          }
        }

    
        // レンダリング
        handleController( controller1 );
	      handleController( controller2 );
        renderer.render(scene, camera);
         
      }
      // 毎フレームごとに秒数を更新して表示
      function updateTime() {
      const seconds = Math.floor(time / 60); // 秒数を計算
      timeContainer.textContent = "Time: " + seconds + " seconds";
      
}
      	
      // リサイズ処理
      window.addEventListener("resize", onResize);
      function onResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize(window.innerWidth, window.innerHeight);
      }

    </script>
  </body>
</html>
